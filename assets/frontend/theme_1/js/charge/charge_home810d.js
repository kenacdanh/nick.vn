$(document).ready(function(){function formatNumber(num){return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,'$1.')}
$('#reload_trangchu').click(function(){$.ajax({type:'GET',cache:false,async:true,url:'/reload-captcha',success:function(data){$(".capchaImage").html(data.captcha);}});});function reload_captcha_home(){$.ajax({type:'GET',cache:false,async:true,url:'/reload-captcha',success:function(data){$(".capchaImage").html(data.captcha);}});}
ele=$('select#telecom option').first();var telecom=ele.val();getAmount(telecom);function getAmount(telecom){if(telecom==null){html='<option value="">-- Vui lòng chọn mệnh giá, sai mất thẻ --</option>';$('select#amount').html(html)
return;}
var url='/ajax/get-amount-tele-card';$.ajax({type:"GET",url:url,cache:false,async:true,data:{telecom:telecom},beforeSend:function(xhr){$('select#amount').html('');},success:function(data){if(data.status==1){let html='';html+='<option value="">-- Vui lòng chọn mệnh giá, sai mất thẻ --</option>';if(data.data.length>0){$.each(data.data,function(key,value){if(value.promotion_ratio&&value.promotion_ratio>0){html+='<option value="'+value.amount+'" rel-ratio="'+value.ratio_default+'">'+formatNumber(value.amount)+' VNĐ - Nhận '+value.ratio_true_amount+'% - KM '+value.promotion_ratio+'</option>';}else{html+='<option value="'+value.amount+'" rel-ratio="'+value.ratio_default+'">'+formatNumber(value.amount)+' VNĐ - Nhận '+value.ratio_true_amount+'% </option>';}});}
$('select#amount').html(html);}},error:function(data){console.log('Có lỗi phát sinh vui lòng liên hệ QTV để kịp thời xử lý.(nạp thẻ (getAmount) )')},complete:function(data){}});}
$('body').on('change','#telecom',function(){var telecom=$(this).val();getAmount(telecom)});$('#form-charge').submit(function(e){e.preventDefault();import('../../lib/fingerprint/fingerprint.js').then(FingerprintJS=>FingerprintJS.load()).then(fp=>fp.get()).then(result=>{const visitorId=result.visitorId;continueFormSubmission(visitorId);}).catch(error=>console.error(error));function continueFormSubmission(visitorId){var formSubmit=$('#form-charge');var url=formSubmit.attr('action');var btnSubmit=formSubmit.find(':submit');btnSubmit.text('Đang xử lý...');btnSubmit.prop('disabled',true);var dataCharge=formSubmit.serialize();dataCharge+="&finger="+visitorId;$.ajax({type:"POST",url:url,cache:false,data:dataCharge,beforeSend:function(xhr){},success:function(data){if(data.status==1){swal({title:"Thành công !",text:data.message,icon:"success",})}
else if(data.status==401){window.location.href='/login?return_url='+window.location.href;}
else if(data.status==0){swal({title:"Nạp thẻ thất bại !",text:data.message,icon:"error",buttons:{cancel:"Đóng",},})}
else{swal({title:"Có lỗi xảy ra !",text:data.message,icon:"error",buttons:{cancel:"Đóng",},})}},error:function(data){console.log('Có lỗi phát sinh vui lòng liên hệ QTV để kịp thời xử lý.(nạp thẻ (postCharge))')},complete:function(data){generateCaptcha()
$('#reload_trangchu').trigger('click');formSubmit.trigger("reset");btnSubmit.text('Nạp thẻ');btnSubmit.prop('disabled',false);}});}});$("#reloadModalCaptcha").on('click',function(){generateCaptcha();});function generateCaptcha(){$.ajax({type:"GET",cache:false,async:true,url:"/reload-captcha",success:function(data){$(".capchaImage").html(data.captcha);},});}});